<template>
    <div v-if="visible" class="emoji-picker" :style="style" @click.stop>
        <div class="emoji-picker-header">
            <input type="text" v-model="searchQuery" placeholder="ÊêúÁ¥¢Ë°®ÊÉÖ..." class="emoji-search-input" />
            <div class="emoji-mode-toggle">
                <label class="mode-label">
                    <input type="checkbox" v-model="localShortcodeMode" @change="toggleMode" />
                    <span>‰ΩøÁî®Áü≠‰ª£Á†Å</span>
                </label>
            </div>
        </div>
        <div class="emoji-category-tabs">
            <div
                v-for="category in categories"
                :key="category.key"
                class="category-tab"
                :class="{ 'active': currentCategory === category.key }"
                @click="selectCategory(category.key)"
            >{{ category.name }}</div>
        </div>
        <div class="emoji-list">
            <div v-for="emoji in currentEmojis" :key="emoji.shortcode" class="emoji-item" @click="selectEmoji(emoji)" :title="`${emoji.description} ${emoji.shortcode}`">
                <span>{{ emoji.emoji }}</span>
                <span v-if="localShortcodeMode" class="shortcode-preview">{{ emoji.shortcode }}</span>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, computed, defineProps, defineEmits, watch, onMounted, onBeforeUnmount, nextTick } from 'vue'
import fullEmoji from 'markdown-it-emoji/lib/data/full.json'
import shortcutsEmoji from 'markdown-it-emoji/lib/data/shortcuts'

const props = defineProps({
    visible: {
        type: Boolean,
        default: false,
    },
    x: {
        type: Number,
        default: 0,
    },
    y: {
        type: Number,
        default: 0,
    },
    shortcodeMode: {
        type: Boolean,
        default: false,
    },
    containerRef: {
        type: Object,
        default: null,
    },
})

const emit = defineEmits(['select', 'close', 'modeChange'])

// Êú¨Âú∞Áü≠‰ª£Á†ÅÊ®°ÂºèÁä∂ÊÄÅ
const localShortcodeMode = ref(props.shortcodeMode)

// ÁõëÂê¨propsÂèòÂåñ
watch(
    () => props.shortcodeMode,
    (newVal) => {
        localShortcodeMode.value = newVal
    }
)

// ÂàáÊç¢Ê®°Âºè
const toggleMode = () => {
    emit('modeChange', localShortcodeMode.value)
}

// ËÆ°ÁÆóËèúÂçï‰ΩçÁΩÆÂíåÂ∞∫ÂØ∏
const pickerWidth = 420 // Â¢ûÂä†ÈÄâÊã©Âô®ÂÆΩÂ∫¶
const pickerHeight = 350 // ‰º∞ËÆ°ÈÄâÊã©Âô®È´òÂ∫¶

// Ê†∑ÂºèËÆ°ÁÆó
const style = computed(() => {
    let x = props.x
    let y = props.y

    // Â¶ÇÊûúÊúâÂÆπÂô®ÂºïÁî®ÔºåÁ°Æ‰øùËèúÂçï‰Ωç‰∫éÂÆπÂô®ÂÜÖ
    if (props.containerRef) {
        const containerRect = props.containerRef.getBoundingClientRect()

        // Ê£ÄÊü•Âè≥ËæπÁïå
        if (x + pickerWidth > containerRect.width) {
            x = containerRect.width - pickerWidth - 10 // ÁïôÂá∫10pxËæπË∑ù
        }

        // Ê£ÄÊü•‰∏ãËæπÁïå
        if (y + pickerHeight > containerRect.height) {
            y = containerRect.height - pickerHeight - 10 // ÁïôÂá∫10pxËæπË∑ù
        }

        // Èò≤Ê≠¢Ë¥üÂÄº
        x = Math.max(10, x)
        y = Math.max(10, y)
    }

    return {
        position: 'absolute',
        left: `${x}px`,
        top: `${y}px`,
        zIndex: 1050, // ÊØî‰∏ä‰∏ãÊñáËèúÂçïÈ´ò‰∏ÄÁ∫ß
        width: `${pickerWidth}px`, // ÊåáÂÆöÂõ∫ÂÆöÂÆΩÂ∫¶
    }
})

// ÊêúÁ¥¢Êü•ËØ¢
const searchQuery = ref('')

// Ë°®ÊÉÖÁ¨¶Âè∑Á±ªÂà´
const categories = [
    { name: 'Â∏∏Áî®', key: 'common' },
    { name: '‰∫∫Áâ©', key: 'people' },
    { name: 'Ëá™ÁÑ∂', key: 'nature' },
    { name: 'È£üÁâ©', key: 'foods' },
    { name: 'Ê¥ªÂä®', key: 'activity' },
    { name: 'Âú∞ÁÇπ', key: 'places' },
    { name: 'Áâ©ÂìÅ', key: 'objects' },
    { name: 'Á¨¶Âè∑', key: 'symbols' },
]

// ÂΩìÂâçÈÄâ‰∏≠ÁöÑÁ±ªÂà´
const currentCategory = ref('common')

// ‰ΩøÁî®Áõ¥Êé•ÂØºÂÖ•ÁöÑemojiÊï∞ÊçÆ
const emojiMappings = fullEmoji

// Â§ÑÁêÜË°®ÊÉÖÊï∞ÊçÆÔºåÊåâÁ±ªÂà´Êï¥ÁêÜ
const processedEmojis = computed(() => {
    const result = {
        common: [], // Â∏∏Áî®Ë°®ÊÉÖ
        people: [], // ‰∫∫Áâ©Ë°®ÊÉÖ
        nature: [], // Ëá™ÁÑ∂
        foods: [], // È£üÁâ©
        activity: [], // Ê¥ªÂä®
        places: [], // Âú∞ÁÇπ
        objects: [], // Áâ©ÂìÅ
        symbols: [], // Á¨¶Âè∑
    }

    // Âà§Êñ≠Ë°®ÊÉÖÁ±ªÂà´ÁöÑÁÆÄÂçïÂáΩÊï∞
    const getCategory = (key) => {
        // ‰∫∫Áâ©Ë°®ÊÉÖ
        if (
            key.includes('face') ||
            key.includes('person') ||
            key.includes('hand') ||
            key.includes('eyes') ||
            key.includes('mouth') ||
            key.includes('tongue')
        )
            return 'people'

        // Ëá™ÁÑ∂‰∏éÂä®Áâ©
        if (
            key.includes('flower') ||
            key.includes('sun') ||
            key.includes('moon') ||
            key.includes('animal') ||
            key.includes('dog') ||
            key.includes('cat') ||
            key.includes('monkey') ||
            key.includes('bird') ||
            key.includes('fish')
        )
            return 'nature'

        // È£üÁâ©‰∏éÈ•ÆÊñô
        if (
            key.includes('food') ||
            key.includes('fruit') ||
            key.includes('pizza') ||
            key.includes('beer') ||
            key.includes('coffee') ||
            key.includes('cake')
        )
            return 'foods'

        // Ê¥ªÂä®‰∏éËøêÂä®
        if (key.includes('ball') || key.includes('game') || key.includes('sport') || key.includes('running') || key.includes('swimming'))
            return 'activity'

        // Âú∞ÁÇπ‰∏é‰∫§ÈÄö
        if (
            key.includes('car') ||
            key.includes('house') ||
            key.includes('building') ||
            key.includes('airplane') ||
            key.includes('train') ||
            key.includes('bus')
        )
            return 'places'

        // Áâ©ÂìÅ‰∏éÂ∑•ÂÖ∑
        if (key.includes('phone') || key.includes('book') || key.includes('computer') || key.includes('tool') || key.includes('clock'))
            return 'objects'

        // Á¨¶Âè∑
        if (key.includes('arrow') || key.includes('heart') || key.includes('star') || key.includes('number') || key.includes('symbol'))
            return 'symbols'

        // Ê†πÊçÆemojiÁöÑÁî®ÈÄîÂà§Êñ≠
        if (['+1', '-1', 'clap', 'wave', 'point_up', 'raised_hands'].includes(key)) return 'people'

        if (['warning', 'exclamation', 'question', 'x', 'o', 'white_check_mark'].includes(key)) return 'symbols'

        // ÈªòËÆ§ÂΩí‰∏∫Â∏∏Áî®
        return 'common'
    }

    // Ê∑ªÂä†Ëá™ÂÆö‰πâÁöÑÂ∏∏Áî®Ë°®ÊÉÖ
    const customCommon = [
        { shortcode: ':smile:', emoji: 'üòÄ', description: 'Á¨ëËÑ∏' },
        { shortcode: ':joy:', emoji: 'üòÇ', description: 'Á¨ëÂì≠' },
        { shortcode: ':heart:', emoji: '‚ù§Ô∏è', description: 'Áà±ÂøÉ' },
        { shortcode: ':thumbsup:', emoji: 'üëç', description: 'Ëµû' },
        { shortcode: ':tada:', emoji: 'üéâ', description: 'Â∫ÜÁ•ù' },
        { shortcode: ':rocket:', emoji: 'üöÄ', description: 'ÁÅ´ÁÆ≠' },
        { shortcode: ':star:', emoji: '‚≠ê', description: 'ÊòüÊòü' },
        { shortcode: ':rainbow:', emoji: 'üåà', description: 'ÂΩ©Ëôπ' },
        { shortcode: ':fire:', emoji: 'üî•', description: 'ÁÅ´' },
        { shortcode: ':thinking:', emoji: 'ü§î', description: 'ÊÄùËÄÉ' },
        { shortcode: ':100:', emoji: 'üíØ', description: '100ÂàÜ' },
        { shortcode: ':zap:', emoji: '‚ö°', description: 'Èó™Áîµ' },
        { shortcode: ':white_check_mark:', emoji: '‚úÖ', description: 'ÂØπÂãæ' },
        { shortcode: ':warning:', emoji: '‚ö†Ô∏è', description: 'Ë≠¶Âëä' },
        { shortcode: ':bulb:', emoji: 'üí°', description: 'ÁÅØÊ≥°' },
    ]

    // Ê∑ªÂä†Ëá™ÂÆö‰πâÂ∏∏Áî®Ë°®ÊÉÖ
    result.common = customCommon

    // Â∞Ümarkdown-it-emojiÁöÑË°®ÊÉÖÊ∑ªÂä†Âà∞ÂØπÂ∫îÁ±ªÂà´
    for (const [key, emoji] of Object.entries(emojiMappings)) {
        const category = getCategory(key)

        // ÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
        if (!result[category].some((e) => e.emoji === emoji)) {
            result[category].push({
                shortcode: `:${key}:`,
                emoji: emoji,
                description: key.replace(/_/g, ' '),
            })
        }
    }

    // Â§ÑÁêÜÂø´Êç∑ÊñπÂºèÊò†Â∞Ñ
    for (const [shortcut, target] of Object.entries(shortcutsEmoji)) {
        // Êü•ÊâæÁõÆÊ†áË°®ÊÉÖ
        const emoji = emojiMappings[target]
        if (emoji) {
            const category = 'common' // ÊâÄÊúâÂø´Êç∑ÊñπÂºèÈÉΩÊîæÂú®Â∏∏Áî®ÂàÜÁ±ªÈáå

            // ÈÅøÂÖçÈáçÂ§çÊ∑ªÂä†
            if (!result[category].some((e) => e.shortcode === `:${shortcut}:`)) {
                result[category].push({
                    shortcode: `:${shortcut}:`,
                    emoji: emoji,
                    description: shortcut.replace(/_/g, ' '),
                })
            }
        }
    }

    return result
})

// ÂΩìÂâçÊòæÁ§∫ÁöÑË°®ÊÉÖ
const currentEmojis = computed(() => {
    const emojis = processedEmojis.value[currentCategory.value] || []

    if (!searchQuery.value) return emojis

    const query = searchQuery.value.toLowerCase()
    return emojis.filter((emoji) => emoji.description.toLowerCase().includes(query) || emoji.shortcode.toLowerCase().includes(query))
})

// ÈÄâÊã©Ë°®ÊÉÖ
const selectEmoji = (item) => {
    // Ê†πÊçÆÊ®°ÂºèÈÄâÊã©ËøîÂõûË°®ÊÉÖÁ¨¶Âè∑ÊàñÁü≠‰ª£Á†Å
    const result = localShortcodeMode.value ? item.shortcode : item.emoji
    emit('select', result)
    emit('close')
}

// ÈÄâÊã©Á±ªÂà´
const selectCategory = (category) => {
    currentCategory.value = category
}

// Â§ÑÁêÜÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÈÄâÊã©Âô®
const handleClickOutside = (event) => {
    // Ê£ÄÊü•ÁÇπÂáªÊòØÂê¶Âú®ÈÄâÊã©Âô®Â§ñÈÉ®
    const picker = document.querySelector('.emoji-picker')
    if (picker && !picker.contains(event.target)) {
        emit('close')
    }
}

// Â§ÑÁêÜESCÈîÆÂÖ≥Èó≠ÈÄâÊã©Âô®
const handleKeyDown = (event) => {
    if (event.key === 'Escape') {
        emit('close')
    }
}

// ÁõëÂê¨ÂèØËßÅÁä∂ÊÄÅ
watch(
    () => props.visible,
    (newVisible) => {
        if (newVisible) {
            nextTick(() => {
                document.addEventListener('click', handleClickOutside)
                document.addEventListener('keydown', handleKeyDown)
            })
            // ÈáçÁΩÆÊêúÁ¥¢
            searchQuery.value = ''
            // ÈáçÁΩÆÁ±ªÂà´
            currentCategory.value = 'common'
        } else {
            document.removeEventListener('click', handleClickOutside)
            document.removeEventListener('keydown', handleKeyDown)
        }
    },
    { immediate: true }
)

// ÁªÑ‰ª∂Âç∏ËΩΩÊó∂Ê∏ÖÁêÜ‰∫ã‰ª∂ÁõëÂê¨Âô®
onBeforeUnmount(() => {
    document.removeEventListener('click', handleClickOutside)
    document.removeEventListener('keydown', handleKeyDown)
})
</script>

<style scoped>
.emoji-picker {
    width: 420px; /* Â¢ûÂä†ÈÄâÊã©Âô®ÂÆΩÂ∫¶‰ª•ÂÆπÁ∫≥‰∏ÄË°åÂàÜÁ±ª */
    background: white;
    border-radius: 4px;
    border: 1px solid rgba(0, 0, 0, 0.15);
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.emoji-picker-header {
    padding: 8px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.emoji-search-input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    font-size: 14px;
    margin-bottom: 6px;
}

.emoji-mode-toggle {
    display: flex;
    justify-content: flex-end;
    font-size: 12px;
    margin-top: 4px;
}

.mode-label {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.mode-label input {
    margin-right: 4px;
}

.emoji-category-tabs {
    display: flex;
    justify-content: space-between; /* ÂùáÂåÄÂàÜÂ∏ÉÂêÑ‰∏™ÂàÜÁ±ª */
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    flex-wrap: nowrap; /* ‰øùËØÅ‰∏çÊç¢Ë°å */
}

.category-tab {
    padding: 6px 8px; /* Á®çÂæÆÂáèÂ∞èÊ∞¥Âπ≥Èó¥Ë∑ù */
    font-size: 12px;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    text-align: center; /* ÊñáÊú¨Â±Ö‰∏≠ */
    flex: 1; /* ÂùáÂàÜÂÆΩÂ∫¶ */
    white-space: nowrap; /* Èò≤Ê≠¢ÊñáÊú¨Êç¢Ë°å */
}

.category-tab.active {
    border-bottom-color: #3b82f6;
    color: #3b82f6;
    font-weight: 500;
}

.category-tab:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.emoji-list {
    max-height: 220px;
    overflow-y: auto;
    padding: 8px;
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start; /* Â∑¶ÂØπÈΩê */
}

.emoji-item {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    cursor: pointer;
    border-radius: 4px;
    position: relative;
    margin: 2px; /* Â¢ûÂä†Èó¥Ë∑ù */
}

.emoji-item:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.shortcode-preview {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    z-index: 10;
}

.emoji-item:hover .shortcode-preview {
    opacity: 1;
}

/* ÊöóÈªëÊ®°ÂºèÊ†∑Âºè */
.dark .emoji-picker {
    background: #1a202c;
    border-color: rgba(255, 255, 255, 0.15);
    color: white;
}

.dark .emoji-picker-header {
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

.dark .emoji-search-input {
    background: #2d3748;
    color: white;
    border-color: rgba(255, 255, 255, 0.2);
}

.dark .emoji-category-tabs {
    border-bottom-color: rgba(255, 255, 255, 0.1);
}

.dark .category-tab.active {
    border-bottom-color: #63b3ed;
    color: #63b3ed;
}

.dark .category-tab:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.dark .emoji-item:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

.dark .shortcode-preview {
    background: #4a5568;
    color: white;
}
</style> 